<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดเก็บเอกสารราชการ</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    
    <style>
        /* (ใส่ CSS เดิมของคุณทั้งหมดตรงนี้ ผมคัดลอกมาเฉพาะส่วนจำเป็นเพื่อไม่ให้โค้ดยาวเกินไป) */
        :root { --primary-color: #001f3f; --accent-color: #3b82f6; --bg-color: #f1f5f9; --text-main: #1e293b; --white: #ffffff;}
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { background: var(--bg-color); color: var(--text-main); }
        .hidden { display: none !important; }
        
        /* Login Screen Styles */
        #login-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #001f3f, #003366, #0056b3); position: relative; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 2.5rem; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); text-align: center; z-index: 10; width: 100%; max-width: 400px; }
        .login-card h2 { color: var(--primary-color); margin-bottom: 0.5rem; }
        .login-card p { color: #64748b; margin-bottom: 2rem; }
        
        /* Layout */
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--primary-color); color: white; padding: 1rem; }
        .main-content { flex-grow: 1; padding: 2rem; }
        
        /* Loader */
        #global-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; }
        #global-loader.active { display: flex; }
    </style>
</head>

<body>
    <div id="global-loader">
        <div style="font-size: 1.5rem; color: var(--primary-color);"><i class="fa-solid fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...</div>
    </div>

    <section id="login-screen">
        <div class="login-card">
            <i class="fa-solid fa-folder-open fa-3x mb-4" style="color: var(--primary-color); margin-bottom: 1rem;"></i>
            <h2>ระบบจัดเก็บเอกสารราชการ</h2>
            <p>กรุณาเข้าสู่ระบบด้วยบัญชี Google</p>
            
            <div id="g_id_onload"
                 data-client_id="422299273146-29j84vfcitgs0tdjkrio8jk2gpqi301t.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-theme="outline" data-size="large" style="display: flex; justify-content: center;"></div>
        </div>
    </section>

    <div class="wrapper hidden" id="main-app">
        <nav class="sidebar">
            <h2>DOCS SYSTEM</h2>
            <hr style="margin: 1rem 0; border-color: rgba(255,255,255,0.1);">
            <div style="cursor: pointer; padding: 0.5rem 0;" onclick="app.logout()"><i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ</div>
        </nav>
        <main class="main-content">
            <h2>แผงควบคุม (Dashboard)</h2>
            <p>ยินดีต้อนรับ, <span id="display-name" style="font-weight: bold; color: var(--accent-color);">-</span></p>
            
            <div style="margin-top: 2rem; padding: 1rem; background: white; border-radius: 8px;">
                <p>จำนวนเอกสารในระบบ: <span id="doc-count">0</span> รายการ</p>
                </div>
        </main>
    </div>

    <script>
        // ==========================================
        // ส่วนสำคัญ: แก้ไข API_URL ให้เป็น Web App URL ของคุณ
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzW3qjG2AiIYDxWrQtuIhQCF1jGQP2vXWYYOeicOUiAOt0GuxW9FnNeOtBSmNJlWEFd/exec'; 

        // 1. ระบบ Login Google
        function handleCredentialResponse(response) {
            // ถอดรหัส Token ของ Google
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            // สลับหน้าจอ
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // แสดงชื่อผู้ใช้
            document.getElementById('display-name').innerText = payload.name;
            
            // เริ่มโหลดข้อมูล
            app.init();
        }

        // 2. ฟังก์ชันหลักสำหรับสื่อสารกับ Backend API (แทน google.script.run)
        const api = {
            // ดึงข้อมูลแบบ GET
            get: async function(action) {
                try {
                    const response = await fetch(`${API_URL}?action=${action}`, { redirect: "follow" });
                    return await response.json();
                } catch (error) {
                    console.error("API GET Error:", error);
                    return { success: false, error: error.message };
                }
            },
            
            // ส่งข้อมูลแบบ POST
            post: async function(action, dataObj) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        redirect: "follow",
                        body: JSON.stringify({ action: action, data: dataObj })
                    });
                    return await response.json();
                } catch (error) {
                    console.error("API POST Error:", error);
                    return { success: false, message: error.message };
                }
            }
        };

        // 3. โครงสร้างแอพพลิเคชัน
        const app = {
            data: {},
            
            init: async function() {
                document.getElementById('global-loader').classList.add('active');
                
                // ตัวอย่างการใช้ api.get แทน google.script.run.getInitialData()
                const res = await api.get('getInitialData');
                
                if (res.success) {
                    app.data = res.data;
                    console.log("โหลดข้อมูลสำเร็จ:", app.data);
                    document.getElementById('doc-count').innerText = app.data.docs.length;
                    
                    // ปลุกฟังก์ชัน Render ตารางของคุณตรงนี้
                    // renderTable(app.data.docs); 
                } else {
                    Swal.fire('เกิดข้อผิดพลาด', res.error || 'ไม่สามารถโหลดข้อมูลได้', 'error');
                }
                
                document.getElementById('global-loader').classList.remove('active');
            },

            // ตัวอย่างการเซฟข้อมูล
            saveDocument: async function(docData) {
                document.getElementById('global-loader').classList.add('active');
                
                // ใช้ api.post แทน google.script.run.saveDocument()
                const res = await api.post('saveDocument', docData);
                
                if(res.success) {
                    Swal.fire('สำเร็จ', 'บันทึกข้อมูลแล้ว', 'success');
                    app.init(); // โหลดข้อมูลใหม่
                } else {
                    Swal.fire('ข้อผิดพลาด', res.message, 'error');
                }
                document.getElementById('global-loader').classList.remove('active');
            },

            logout: function() {
                // เคลียร์หน้าจอและกลับไปหน้า Login
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
